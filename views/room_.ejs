<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        .active > .answer-actions > button {
        display: none;
      }

      .active > .answer-actions > .writing {
        display: inherit;
        width: 300px;
        height: 25px;
        padding: 1px;
        background-color: chocolate;
        line-height: 25px;
        font-size: 20px;
        color: #eeeeee;
        text-align: center;
      }

      .writing {
        display: none;
      }

      .inline-block {
        display: inline-block;
      }

      .answer {
        margin: 5px;
        border: 3px solid #eee;
        width: 750px;
        height: 150px;
        padding: 10px;
        box-sizing: border-box;
      }

      .answer-actions {
        float: right;
      }

      .answer-text {
        width: 400px;
      }

      .btn {
        padding: 1px;
        border: none;
        border-radius: 5%;
        width: 100px;
        height: 25px;
        color: white;
        font-weight: bold;
        outline: none;
      }

      .warning {
        background-color: orange;
      }

      .error {
        background-color: red;
      }

      .success {
        background-color: green;
      }

      .warning:hover {
        background-color: #ff9400;
      }

      .error:hover {
        background-color: #ee0000;
      }

      .success:hover {
        background-color: #007000;
      }
    </style>
</head>

<body>
    <h1>
        <%= room.PIN%>
    </h1>
    <h2 id='pytanie'></h2>
    <ul id="guests"></ul>
    <div id="content">
        <% if(user && room.OPEN != false ){ %>
        <form id="qform">
            <input id='qinput' type="text">
            <button id="qbutton">Wyślij</button>
        </form>
        <% }else{ %>


        <% } %>

    </div>

    <div id="a"></div>








</body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    //    var socket = io({transports: ['websocket'], upgrade: false});l

    const socket = io();
    let list;
    let oczekiwanie = false;
    let boolean = false;
    //DOŁĄCZANIE
    socket.on('connect', () => {
        socket.emit('room', <%= room.PIN %>, boolean);
        <% if(user) {%>
        boolean = true;
        <% } if(!user && room.OPEN == false) {%>
        document.getElementById('content').innerHTML = "<div id='area' contenteditable='true'>  </div>";
        $('#content').append("<button onclick='wyslij()' id='przycisk'>Wyślij</button>")

        <% } if(user && room.OPEN == false) { %>
        $('#content').append("<button id='qbutton'>Zakończ</button>")
        socket.emit('glist', socket.id)
        <% } %>
        console.log(socket.id); // true



    });


    //WYŚWIETLANIE LISTY
    socket.on('join_room', (nroom) => {
        list = nroom;
        <% if (room.OPEN != false){ %>
        console.log(nroom)
        document.getElementById('guests').innerHTML = "";
        nroom.forEach(function(guest) {
            $('#guests').append($('<li>').text(guest.username));
        })
        <%    } %>
    })

    //ZADANIE PYTANIA
    $('#qbutton').click((e) => {
        e.preventDefault();
        let qinput = $('#qinput').val();
        socket.emit("question", qinput, <%= room.PIN %>);
    })
    //Wyświetlanie pytania
    socket.on('qquestion', (qinput) => {
        document.getElementById('guests').innerHTML = "";
        <% if(user){  %>
        $('#content').append("<button id='qbutton'>Zakończ</button>")
        <% }else { %>
        document.getElementById('content').innerHTML = "<div id='area' contenteditable='true'></div>"
        $('#content').append("<button onclick='wyslij()' id='przycisk'>Wyślij</button>")
        <% } %>
        socket.emit('glist', socket.id)
    })


    //Przesyłanie odpowiedzi
    setInterval(function() {

        <% if(!user) { %>

        if ($('#area').val() != " " && oczekiwanie == false) {
            let xd = $('#area').text();
            oczekiwanie = false;
            socket.emit('odp', <%= room.PIN %>, xd, '<%= fguest.id %>');
        }
        <% } %>
    }, 5000)


    //Wyświetlanie odpowiedzi
    socket.on('lista', (glist) => {
        console.log(list)
        list.forEach(function(guest) {

            $('#a').append(`<div class="answer ` + guest._id + `">
        <div class="answer-text inline-block">
        </div>
        <div class="answer-actions inline-block">
            <button class="btn warning">Bledy</button>
            <button class="btn error">Odrzuć</button>
            <button class="btn success">Dobrze</button>
            <a class="writing">Someone is writing</a>
        </div>
    </div>`)

        })
    })

    socket.on('godp', (text, gid) => {
        console.log(text)
        //        console.log( $("#" + gid))
        //        console.log( $("#a")
        $("." + gid).children().first().text(text);
    })



    //Wysyłanie odpowiedzi
    <%  if(!user){ %>

    function wyslij() {
        if (oczekiwanie == false) {
            let ans = $('#area').text();
            $('#area').text(" ");
            oczekiwanie = true;
            socket.emit('ans', socket.id, ans, '<%= fguest.id %>', <%= room.PIN %>);
        }
    }
    <%}%>




    <%  if(user){ %>
    socket.on('wys', (socid, text, g) => {
        $('.'+g._id).attr('.active');
    })
    <%}%>

</script>

</html>
