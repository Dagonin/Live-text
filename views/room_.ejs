<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <link rel="stylesheet" href="/css/room.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400&display=swap" rel="stylesheet">
    <link href="/css/fontawesome/css/all.css" rel="stylesheet">
</head>

<body>

<!--Timer-->
<div id="timer"></div>
<!--Numer pokoju -->
<% if(room.OPEN==true && user){ %>
<div class="room">
<div class="room-title"><i class="fas fa-cog icon_mg"></i> Zarządzanie pokojem</div>
<div id="pinpokoju" class="etykieta"> Kod Klasy <br><br>
<span class="room-pin"><%= room.PIN %></span> </div><br>
<!--Lista guestów-->
<div class="etykieta"><i class="fas fa-user-friends icon_mg"></i></i> Lista gości</div><br>
<div id="guestlist"></div><br>
<button onclick="startgame()" class="startgame"><i class="fas fa-play icon_mg"></i> ROZPOCZNIJ</button>
<% }else if(room.OPEN){ %>
<!--Lista guestów-->
<div id="guestlist"></div>
</div>


<% } %>
<!--Treść pytania-->
<div id="gamequestions">
<% if(!user && room.OPEN == false){ %>
<div id="question"></div>
<div id="answers"></div>
<% if(room.time){ %>
<button onclick="changequestion(-1)">Poprzednie pytanie</button>
<% } %>
<button onclick="changequestion(1)">Następne pytanie</button>
<% } %>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    let room;
    let guestlist;
    let questions;
    let guest;
    let timerinverval;
    let checktimeinterval;
    const socket = io();
            socket.on('connect', () => {
                console.log(socket.id)
                <% if(!user){ %>
                socket.emit('addSocketIDToGuest','<%= fguest._id %>',socket.id);
                <% }if(!user && room.OPEN == false){ %>
                checktimeinterval = setInterval(checktime,1000)
                timer(<%= fguest.time %>-timeremaining())
                <% }%>
                socket.emit('joinroom',"<%= room.PIN %>",<%= room.OPEN %>);

        });
    
    

    
    
    
    //SOCKETIO
    
    
    
    //Lista guestów
    socket.on('reloadlist',(fRoom,fGuests,fQuestions)=>{
        <% if(room.OPEN==true){ %>
        room = fRoom;
        guestlist = fGuests;
        questions = fQuestions;
        $("#guestlist").html("")
        $.each(guestlist,function(){
            $("#guestlist").append(`<div>`+this.username+ <% if(user){ %>   `<button onclick="deleteguest(this)" db-id="`+this._id+`"><i class="fas fa-times"></i></button> ` +  <% } %> `</div>`)
            
        })
        <% }else{ %>
        room = fRoom;
        guestlist = fGuests;
        questions = fQuestions;
        <% } %>
    })
    
    socket.on('Nguest',(g)=>{
        guest = g;
    })
    
    

    
    //Wyrzucenie guesta z pokoju
    <% if(user){ %> 
    function deleteguest(e){
        socket.emit('deleteguest',$(e).attr('db-id'),"<%= room.PIN %>");
    }

    <% } %>
    socket.on('leaveroom',(e)=>{
        socket.emit('leaveroom1',"<%= room.PIN %>");
        location.reload();
        
    })
    
    
    //Rozpoczęcie gry
    <% if(room.OPEN==true){ %>
    function startgame(){
        <% room.OPEN=false %>
        socket.emit('startgame',"<%= room.PIN %>","<%= room.id %>")
            
    }
    <% } %>
                    
                    
    socket.on('lastload',(nRoom,fQuestions)=>{
            room = nRoom;
            questions = fQuestions;
            <% if(!user){ %>
            <% if(room.time){%>
            $("#gamequestions").html(`<div id="question"></div><div id="answers"></div>
    <button onclick="changequestion(-1)">Poprzednie pytanie</button>
    <button onclick="changequestion(1)">Następne pytanie</button>`);
            $("#guestlist").remove();
            socket.emit('addtimeguest',"<%= fguest.id %>",'<%= room.time %>');
            changequestion(0);
            checktimeinterval = setInterval(checktime,1000)
            timer((<%= room.time %>*60))
            <% }else{%>
            $("#gamequestions").html(`<div id="question"></div>
    <button onclick="changequestion(1)">Następne pytanie</button>`);
            $("#guestlist").remove();
            let type = questions[0].type;
            let starttime;
            if(type=="open"){
                starttime = <%= room.opentime %>+"";
            }else if(type=="multi"||type=="single"){
                starttime = <%= room.closedtime %>+"";
            }
            changequestion(0);
            checktimeinterval = setInterval(checktime,1000)
            timer(starttime);
            <% }%>

            <% } %>
        })    
        
        
        
    //Zmiana pytania
        <% if(!user){ %>
        function changequestion(num){
            <% if(!room.time){%>
                if(num<0){
                    num = num*-1;
                }
            <% }%>
            guest.index += num;
            if(guest.index<0){
                guest.index = 0;
            }
            if(guest.index>=questions.length){
                <% if(room.time){ %>
                guest.index = questions.length-1;
                <%}else{ %>
                // KONIEC Testu
                    clearInterval(checktimeinterval);
                    clearInterval(timerinverval)
                    $("#gamequestions").html('')
                    return false;
                <% } %>
            }
            console.log(questions[guest.index]);
            //WYŚWITLANIE PYTANIA                         WĄŻŃĘ////////////////////////////////////////////
            $("#question").html(questions[guest.index].content);
            if(questions[guest.index].type!="open"){
                $("#answers").html("");
                let optionindex=0;
                questions[guest.index].option.forEach(option=>{
                    $("#answers").append("<div onclick=check(this,'"+questions[guest.index].type+"') id="+optionindex+">"+option+"</div>");
                    optionindex++;
                }) 
            }else{
                $("#answers").html(`<textarea rows="4" cols="50">Tu bedzie quill</textarea>`);
            }
            <% if(!room.time){ %>
               if(questions[guest.index].type=='open'){
                   timer(<%= room.opentime %>)
               }else{
                   timer(<%= room.closedtime %>)
               }
            <% } %>
            
            socket.emit("changeindex","<%= fguest.id %>",guest.index,questions[guest.index].type,'<%= room.opentime %>','<%= room.closedtime %>','<%= room.time %>')
            
        }
        <% } %>
    //Timer
        function timer(time){
                function changetime(){
                let min = Math.floor(time/60);
                let sec = time%60;
                $("#timer").text(min+":"+sec) 
                
                if(time<=0){
                    timeout();
                    clearInterval(timerinverval)
                }  
                    time--;
                }
                
                if(timerinverval){
                clearInterval(timerinverval);
                timerinverval=undefined;
                }
                
                timerinverval = setInterval(changetime,1000,time);
            }
            
        function checktime(){
            if(timeremaining() >guest.time){
                timeout();
            }
        }    
            
        function timeremaining(){
            let currentdate = new Date();
            return currentdate.getHours()*3600+currentdate.getMinutes()*60+currentdate.getSeconds();
        }
            
        function timeout(){

//            <% if(room.time){ %>
                    clearInterval(timerinverval)
                    $("#gamequestions").html('')
//            <%}else{ %>
            clearInterval(timerinverval);
            changequestion(1);
            
            <% } %>
        }
            
            function check(e,type){    
                if(type=="single"&& $(".toggle").length==1){
                    $(".toggle").toggleClass("toggle");
                }
                e.classList.toggle("toggle")
            }
            
            

</script>

</html>
